{% extends 'base.html' %}

{% block title %}
  {% if pk %}تعديل المنتج{% else %}إضافة منتج جديد{% endif %}
{% endblock %}

{% block extra_css %}
<style>
  /* ===== بطاقة النموذج ===== */
  .form-card {
    background: #fff;
    max-width: 500px;
    margin: 2rem auto;           /* مركزي الأفقياً */
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.1);
    direction: rtl;
    text-align: right;
    font-family: 'Cairo', sans-serif;
  }

  /* ===== عنوان النموذج ===== */
  .form-card h2 {
    margin-bottom: 1.5rem;
    font-size: 1.6rem;
    color: #222;
  }

  /* ===== فئات الحقول ===== */
  .form-group {
    margin-bottom: 1.25rem;
  }
  .form-group label {
    display: block;
    margin-bottom: .4rem;
    font-weight: 500;
    color: #444;
    font-size: 1rem;
  }
  .form-group input,
  .form-group textarea {
    width: 100%;
    padding: .65rem 1rem;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: .95rem;
    font-family: inherit;
  }
  .form-group textarea {
    min-height: 100px;
    resize: vertical;
  }

  /* ===== عرض أخطاء الحقول ===== */
  .errorlist {
    margin-top: .4rem;
    color: #dc3545;
    list-style: none;
    padding: 0;
  }
  .errorlist li {
    font-size: .9rem;
  }

  /* ===== أزرار الحفظ والإلغاء ===== */
  .form-actions {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-top: 2rem;
  }
  .form-actions button,
  .form-actions a {
    flex: 1;
    padding: .75rem 0;
    border: none;
    border-radius: 4px;
    font-weight: 600;
    text-decoration: none;
    font-size: 1rem;
    cursor: pointer;
    transition: background .2s, transform .1s;
    color: #fff;
    font-family: inherit;
  }
  .form-actions button {
    background: #28a745;
  }
  .form-actions button:hover {
    background: #218838;
    transform: translateY(-1px);
  }
  .form-actions a {
    background: #6c757d;
    text-align: center;
    line-height: 1.6;
  }
  .form-actions a:hover {
    background: #5a6268;
    transform: translateY(-1px);
  }
</style>
{% endblock %}

{% block content %}
<div class="form-card">
  <h2>{% if pk %}تعديل المنتج{% else %}إضافة منتج جديد{% endif %}</h2>

  {# data-pk هنا في الفورم مباشرةً #}
  <form id="product-form" data-pk="{{ pk|default:'' }}">
    {% csrf_token %}
    <div id="form-error" class="errorlist" style="display:none;"></div>

    <div class="form-group">
      <label for="name">الاسم</label>
      <input type="text" id="name" name="name" required />
    </div>

    <div class="form-group">
      <label for="description">الوصف</label>
      <textarea id="description" name="description"></textarea>
    </div>

    <div class="form-group">
      <label for="price">السعر (USD)</label>
      <input type="number" id="price" name="price" step="0.01" required />
    </div>

    <div class="form-actions">
      <button type="submit">حفظ</button>
      <a href="{% url 'admin_dashboard:product_list' %}">إلغاء</a>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 1) دالة لقراءة CSRF من الكوكيز
function getCookie(name) {
  let value = null;
  document.cookie.split(';').forEach(c => {
    let [k, v] = c.trim().split('=');
    if (k === name) value = decodeURIComponent(v);
  });
  return value;
}

document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('product-form');
  const pkRaw = form.dataset.pk;
  const pk    = pkRaw ? Number(pkRaw) : null;
  const errDiv= document.getElementById('form-error');
  const csrftoken = getCookie('csrftoken');

  // 2) جلب البيانات لملء الحقول إذا تعديل
  if (pk) {
    fetch(`/api/products/${pk}/`, {
      credentials: 'same-origin'
    })
    .then(r => r.json())
    .then(p => {
      form.name.value        = p.name;
      form.description.value = p.description;
      form.price.value       = p.price;
    })
    .catch(console.error);
  }

  // 3) عند الضغط على "حفظ"
  form.addEventListener('submit', e => {
    e.preventDefault();
    errDiv.style.display = 'none';
    errDiv.innerHTML     = '';

    const payload = {
      name:        form.name.value,
      description: form.description.value,
      price:       form.price.value
    };

    // 4) إرسال الطلب (POST أو PUT)
    fetch(pk ? `/api/products/${pk}/` : `/api/products/`, {
      method: pk ? 'PUT' : 'POST',
      credentials: 'same-origin',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken,
        'Accept': 'application/json'
      },
      body: JSON.stringify(payload)
    })
    .then(res => {
      console.log('Status:', res.status);
      if (!res.ok) return res.json().then(err => Promise.reject(err));
      // 5) نجاح → إعادة التوجيه لإدارة المنتجات
      window.location.href = "{% url 'admin_dashboard:product_list' %}";
    })
    .catch(err => {
      console.error(err);
      // 6) عرض الأخطاء
      errDiv.innerHTML = '';
      Object.entries(err).forEach(([field, msgs]) => {
        msgs.forEach(m => {
          const li = document.createElement('li');
          li.textContent = `${field}: ${m}`;
          errDiv.appendChild(li);
        });
      });
      errDiv.style.display = 'block';
    });
  });
});
</script>
{% endblock %}

