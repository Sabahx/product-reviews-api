{% extends "home.html" %}
{% load static %}

{% block content %}
<div class="container my-5">

  <h2 class="mb-4">ูุงุฆูุฉ ุงูููุชุฌุงุช</h2>

  <!-- โ ุดุฑูุท ุงูุจุญุซ ูุงูุชุตููุฉ -->
  <form method="get" class="row mb-4">
    <!-- Search Input -->
    <div class="col-md-4 mb-2">
      <input type="text" id="searchInput" name="search" value="{{ request.GET.search }}" class="form-control" placeholder="ุงุจุญุซ ุนู ููุชุฌ...">
    </div>

    <!-- Rating Filter -->
    <div class="col-md-2 mb-2">
      <select name="rating" class="form-select">
        <option value="">ุงูุชูููู</option>
        <option value="5" {% if request.GET.rating == '5' %}selected{% endif %}>โโโโโ (5)</option>
        <option value="4" {% if request.GET.rating == '4' %}selected{% endif %}>โโโโโ (4)</option>
        <option value="3" {% if request.GET.rating == '3' %}selected{% endif %}>โโโโโ (3)</option>
        <option value="2" {% if request.GET.rating == '2' %}selected{% endif %}>โโโโโ (2)</option>
        <option value="1" {% if request.GET.rating == '1' %}selected{% endif %}>โโโโโ (1)</option>
      </select>
    </div>

    <!-- Sort Options -->
    <div class="col-md-4 mb-2">
      <select id="sortSelect" name="sort" class="form-select">
        <option value="">ุชุฑุชูุจ ุญุณุจ</option>
        <option value="price_asc" {% if request.GET.sort == 'price_asc' %}selected{% endif %}>ุงูุณุนุฑ: ุชุตุงุนุฏู</option>
        <option value="price_desc" {% if request.GET.sort == 'price_desc' %}selected{% endif %}>ุงูุณุนุฑ: ุชูุงุฒูู</option>
        <option value="rating" {% if request.GET.sort == 'rating' %}selected{% endif %}>ุงูุฃุนูู ุชููููุงู</option>
        <option value="reviews" {% if request.GET.sort == 'reviews' %}selected{% endif %}>ุงูุฃูุซุฑ ูุฑุงุฌุนุงุช</option>
      </select>
    </div>

    <!-- Submit Button -->
    <div class="col-md-2 mb-2">
      <button type="submit" class="btn btn-primary w-100">ุชุตููุฉ</button>
    </div>
  </form>

  <!-- โ ุญุงููุฉ ุนุฑุถ ุงูููุชุฌุงุช -->
  <div id="productsContainer" class="row g-4">
    {% for product in products %}
      <div class="col-md-4 product-item"
           data-name="{{ product.name|lower }}"
           data-price="{{ product.price }}"
           data-rating="{{ product.average_rating|default:0 }}"
           data-reviews="{{ product.reviews_count }}">
        <div class="card h-100 shadow-sm">
          <img src="https://via.placeholder.com/300x200.png?text=No+Image" class="card-img-top" alt="{{ product.name }}">
          <div class="card-body">
            <h5 class="card-title">{{ product.name }}</h5>
            <p class="card-text text-muted">{{ product.description|truncatewords:15 }}</p>
            <p class="mb-1">๐ฐ ุงูุณุนุฑ: {{ product.price }} $</p>
            <p class="mb-1">โญ ุงูุชูููู: {{ product.average_rating|default:"0"|floatformat:1 }}</p>
            <p class="mb-2">๐ ุนุฏุฏ ุงููุฑุงุฌุนุงุช: {{ product.reviews_count }}</p>
            <a href="{% url 'product-detail' product.id %}" class="btn btn-primary w-100">ุนุฑุถ ุงูุชูุงุตูู</a>
          </div>
        </div>
      </div>
    {% empty %}
      <p>ูุง ุชูุฌุฏ ููุชุฌุงุช ุญุงููุงู.</p>
    {% endfor %}
  </div>

</div>

<!-- โ ุณูุฑุจุช ููุชุฑุฉ ูุชุฑุชูุจ ุงูููุชุฌุงุช -->
<script>
  const searchInput = document.getElementById('searchInput');
  const sortSelect = document.getElementById('sortSelect');
  const productItems = document.querySelectorAll('.product-item');

  if (searchInput) {
    searchInput.addEventListener('input', filterProducts);
  }

  if (sortSelect) {
    sortSelect.addEventListener('change', sortProducts);
  }

  function filterProducts() {
    const searchTerm = searchInput.value.toLowerCase();
    productItems.forEach(item => {
      const name = item.dataset.name;
      item.style.display = name.includes(searchTerm) ? 'block' : 'none';
    });
  }

  function sortProducts() {
    const sortBy = sortSelect.value;
    const container = document.getElementById('productsContainer');
    const productsArray = Array.from(productItems);

    productsArray.sort((a, b) => {
      let aValue, bValue;
      switch (sortBy) {
        case 'price_asc':
          aValue = parseFloat(a.dataset.price);
          bValue = parseFloat(b.dataset.price);
          return aValue - bValue;
        case 'price_desc':
          aValue = parseFloat(a.dataset.price);
          bValue = parseFloat(b.dataset.price);
          return bValue - aValue;
        case 'rating':
          aValue = parseFloat(a.dataset.rating);
          bValue = parseFloat(b.dataset.rating);
          return bValue - aValue;
        case 'reviews':
          aValue = parseInt(a.dataset.reviews);
          bValue = parseInt(b.dataset.reviews);
          return bValue - aValue;
        default:
          return 0;
      }
    });

    productsArray.forEach(p => container.appendChild(p));
  }

  function resetFilters() {
    searchInput.value = '';
    sortSelect.value = '';
    productItems.forEach(item => item.style.display = 'block');
  }
</script>
{% endblock %}
