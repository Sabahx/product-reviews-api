{% extends "home.html" %}
{% load static %}
{% load humanize %}  {# Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙˆÙ‚Øª Ø¨ØµÙŠØºØ© Ø·Ø¨ÙŠØ¹ÙŠØ© #}

{% block content %}
<div class="container my-5">
  <h2>{{ product.name }}</h2>

  <!-- ğŸ”¹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ -->
  <div class="row mb-4">
    <div class="col-md-6">
      {% if product.image %}
        <img src="{{ product.image.url }}" class="img-fluid rounded shadow" alt="{{ product.name }}">
      {% else %}
        <img src="https://via.placeholder.com/400x300.png?text=No+Image" class="img-fluid rounded shadow" alt="{{ product.name }}">
      {% endif %}
    </div>
    <div class="col-md-6">
      <div class="product-info">
        <p class="lead">{{ product.description }}</p>
        <div class="price-section mb-3">
          <h4 class="text-success"><strong>ğŸ’° Ø§Ù„Ø³Ø¹Ø±:</strong> {{ product.price }} â‚º</h4>
        </div>
        <div class="rating-section mb-3">
          <p class="mb-1"><strong>â­ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:</strong> 
            <span class="text-warning">
              {% for i in "12345" %}
                {% if i|add:0 <= product.average_rating %}
                  â­
                {% else %}
                  â˜†
                {% endif %}
              {% endfor %}
            </span>
            <span class="text-muted">({{ product.average_rating|floatformat:1 }})</span>
          </p>
          <p><strong>ğŸ“ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª:</strong> {{ product.reviews_count }}</p>
        </div>
        
        <!-- Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙØ¶Ù„Ø© -->
        {% if user.is_authenticated %}
          <form method="post" action="{% url 'toggle-favorite' product.id %}" class="d-inline">
            {% csrf_token %}
            {% if is_favorite %}
              <button type="submit" class="btn btn-outline-danger">
                â¤ï¸ Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©
              </button>
            {% else %}
              <button type="submit" class="btn btn-outline-primary">
                ğŸ¤ Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ÙØ¶Ù„Ø©
              </button>
            {% endif %}
          </form>
        {% endif %}
      </div>
    </div>
  </div>

  <hr>

  <!-- ğŸ”¹ Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø§Ø¬Ø¹Ø© -->
  {% if user.is_authenticated %}
    <!-- Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø³Ø§Ø¨Ù‚Ø© -->
    {% if user_has_reviewed %}
      <div class="alert alert-info">
        <strong>ğŸ“ Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ù‚Ø¨Ù„!</strong>
        <a href="#your-review" class="alert-link">Ø§Ù†ØªÙ‚Ù„ Ø¥Ù„Ù‰ Ù…Ø±Ø§Ø¬Ø¹ØªÙƒ</a>
      </div>
    {% else %}
      <h5>ğŸ“ Ø£Ø¶Ù Ù…Ø±Ø§Ø¬Ø¹Ø©</h5>
      <form method="post" action="{% url 'add-review' product.id %}" class="mb-4" id="review-form">
        {% csrf_token %}
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:</label>
              <div class="rating-input">
                {% for i in "12345" %}
                  <input type="radio" name="rating" value="{{ i }}" id="star{{ i }}" required>
                  <label for="star{{ i }}" class="star-label">â­</label>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">Ù†Øµ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©:</label>
          <textarea name="review_text" class="form-control" rows="4" placeholder="Ø´Ø§Ø±ÙƒÙ†Ø§ ØªØ¬Ø±Ø¨ØªÙƒ Ù…Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬..." required></textarea>
          <div class="form-text">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ 10 Ø£Ø­Ø±Ù</div>
        </div>
        <button type="submit" class="btn btn-success">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</button>
      </form>
    {% endif %}
  {% else %}
    <div class="alert alert-warning">
      <strong>Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„ÙƒØªØ§Ø¨Ø© Ù…Ø±Ø§Ø¬Ø¹Ø©</strong>
      <a href="{% url 'login' %}" class="btn btn-sm btn-primary ms-2">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
    </div>
  {% endif %}

  <hr>

  <!-- ğŸ”¹ ÙÙ„ØªØ± ÙˆØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª -->
  <div class="reviews-header d-flex justify-content-between align-items-center mb-3">
    <h4>Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª ({{ reviews.count }})</h4>
    <div class="review-filters">
      <form method="get" class="d-flex gap-2">
        <select name="sort" class="form-select form-select-sm" onchange="this.form.submit()">
          <option value="newest" {% if request.GET.sort == 'newest' %}selected{% endif %}>Ø§Ù„Ø£Ø­Ø¯Ø«</option>
          <option value="oldest" {% if request.GET.sort == 'oldest' %}selected{% endif %}>Ø§Ù„Ø£Ù‚Ø¯Ù…</option>
          <option value="highest" {% if request.GET.sort == 'highest' %}selected{% endif %}>Ø£Ø¹Ù„Ù‰ ØªÙ‚ÙŠÙŠÙ…</option>
          <option value="lowest" {% if request.GET.sort == 'lowest' %}selected{% endif %}>Ø£Ù‚Ù„ ØªÙ‚ÙŠÙŠÙ…</option>
          <option value="helpful" {% if request.GET.sort == 'helpful' %}selected{% endif %}>Ø§Ù„Ø£ÙƒØ«Ø± ÙØ§Ø¦Ø¯Ø©</option>
        </select>
        <select name="rating_filter" class="form-select form-select-sm" onchange="this.form.submit()">
          <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</option>
          {% for i in "54321" %}
            <option value="{{ i }}" {% if request.GET.rating_filter == i %}selected{% endif %}>{{ i }} Ù†Ø¬ÙˆÙ…</option>
          {% endfor %}
        </select>
      </form>
    </div>
  </div>

  <!-- ğŸ”¹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª -->
  {% for review in reviews %}
    <div class="card mb-3 review-card" {% if review.user == user %}id="your-review"{% endif %}>
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <div class="reviewer-info">
            <h5 class="card-title mb-1">
              {{ review.user.username }}
              {% if review.user == user %}
                <span class="badge bg-primary">Ù…Ø±Ø§Ø¬Ø¹ØªÙƒ</span>
              {% endif %}
            </h5>
            <div class="rating-stars mb-2">
              {% for i in "12345" %}
                {% if i|add:0 <= review.rating %}
                  <span class="text-warning">â­</span>
                {% else %}
                  <span class="text-muted">â˜†</span>
                {% endif %}
              {% endfor %}
              <span class="ms-2 text-muted">{{ review.rating }}/5</span>
            </div>
          </div>
          <small class="text-muted">{{ review.created_at|naturaltime }}</small>
        </div>
        
        <p class="review-text">{{ review.review_text }}</p>
        
        <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙØ§Ø¹Ù„ -->
        <div class="review-actions d-flex gap-2 mb-3">
          {% if user.is_authenticated and user != review.user %}
            <!-- Ø£Ø²Ø±Ø§Ø± Ù…ÙÙŠØ¯/ØºÙŠØ± Ù…ÙÙŠØ¯ -->
            <form method="post" action="{% url 'review-helpful' review.id %}" class="d-inline">
              {% csrf_token %}
              <button type="submit" name="action" value="helpful" 
                      class="btn btn-sm btn-outline-success {% if user in review.helpful_users.all %}active{% endif %}">
                ğŸ‘ Ù…ÙÙŠØ¯ ({{ review.helpful_count }})
              </button>
            </form>
            <form method="post" action="{% url 'review-helpful' review.id %}" class="d-inline">
              {% csrf_token %}
              <button type="submit" name="action" value="unhelpful" 
                      class="btn btn-sm btn-outline-danger {% if user in review.unhelpful_users.all %}active{% endif %}">
                ğŸ‘ ØºÙŠØ± Ù…ÙÙŠØ¯ ({{ review.unhelpful_count }})
              </button>
            </form>
          {% else %}
            <span class="text-muted">
              ğŸ‘ {{ review.helpful_count }} | ğŸ‘ {{ review.unhelpful_count }}
            </span>
          {% endif %}

          <!-- Ø²Ø± Ø§Ù„Ø¥Ø¨Ù„Ø§Øº -->
          {% if user.is_authenticated and user != review.user %}
            <button type="button" class="btn btn-sm btn-outline-warning" 
                    data-bs-toggle="modal" data-bs-target="#reportModal{{ review.id }}">
              ğŸš© Ø¥Ø¨Ù„Ø§Øº
            </button>
          {% endif %}
        </div>

        <!-- ğŸ”¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© -->
        <div class="comments-section ms-3 mt-3" id="comments-{{ review.id }}">
          <h6 class="text-muted">ğŸ’¬ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ({{ review.comments.count }}):</h6>
          
          <div class="comments-list">
            {% for comment in review.comments.all %}
              <div class="comment mb-2 p-2 bg-light rounded">
                <div class="d-flex justify-content-between">
                  <strong>{{ comment.user.username }}:</strong>
                  <small class="text-muted">{{ comment.created_at|naturaltime }}</small>
                </div>
                <div class="comment-text">{{ comment.text }}</div>
              </div>
            {% empty %}
              <p class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø¨Ø¹Ø¯.</p>
            {% endfor %}
          </div>

          <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚ -->
          {% if user.is_authenticated %}
            <form method="post" action="{% url 'add-comment' review.id %}" 
                  class="comment-form mt-2" data-review-id="{{ review.id }}">
              {% csrf_token %}
              <div class="mb-2">
                <textarea name="text" class="form-control form-control-sm" 
                          rows="2" placeholder="Ø£Ø¶Ù ØªØ¹Ù„ÙŠÙ‚Ùƒ..." required></textarea>
              </div>
              <button type="submit" class="btn btn-sm btn-outline-primary">
                Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
              </button>
            </form>
          {% else %}
            <p class="text-muted small">
              <a href="{% url 'login' %}">Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a> Ù„Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚
            </p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Modal Ù„Ù„Ø¥Ø¨Ù„Ø§Øº -->
    {% if user.is_authenticated and user != review.user %}
      <div class="modal fade" id="reportModal{{ review.id }}" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'report-review' review.id %}">
              <div class="modal-body">
                {% csrf_token %}
                <div class="mb-3">
                  <label class="form-label">Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº:</label>
                  <select name="reason" class="form-select" required>
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³Ø¨Ø¨</option>
                    <option value="spam">Ù…Ø­ØªÙˆÙ‰ Ù…Ø²Ø¹Ø¬</option>
                    <option value="inappropriate">Ù…Ø­ØªÙˆÙ‰ ØºÙŠØ± Ù„Ø§Ø¦Ù‚</option>
                    <option value="fake">Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ø²ÙŠÙØ©</option>
                    <option value="offensive">Ù…Ø­ØªÙˆÙ‰ Ù…Ø³ÙŠØ¡</option>
                    <option value="other">Ø£Ø®Ø±Ù‰</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                  <textarea name="details" class="form-control" rows="3"></textarea>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="submit" class="btn btn-danger">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    {% endif %}

  {% empty %}
    <div class="text-center py-5">
      <div class="mb-3">
        <i class="fas fa-comment-slash fa-3x text-muted"></i>
      </div>
      <h5 class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±Ø§Ø¬Ø¹Ø§Øª Ø¨Ø¹Ø¯</h5>
      <p class="text-muted">ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠØ±Ø§Ø¬Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬!</p>
    </div>
  {% endfor %}

  <!-- Pagination Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª -->
  {% if reviews.has_other_pages %}
    <nav aria-label="ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª">
      <ul class="pagination justify-content-center">
        {% if reviews.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ reviews.previous_page_number }}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.rating_filter %}&rating_filter={{ request.GET.rating_filter }}{% endif %}">Ø§Ù„Ø³Ø§Ø¨Ù‚</a>
          </li>
        {% endif %}
        
        {% for num in reviews.paginator.page_range %}
          {% if reviews.number == num %}
            <li class="page-item active">
              <span class="page-link">{{ num }}</span>
            </li>
          {% else %}
            <li class="page-item">
              <a class="page-link" href="?page={{ num }}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.rating_filter %}&rating_filter={{ request.GET.rating_filter }}{% endif %}">{{ num }}</a>
            </li>
          {% endif %}
        {% endfor %}
        
        {% if reviews.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ reviews.next_page_number }}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.rating_filter %}&rating_filter={{ request.GET.rating_filter }}{% endif %}">Ø§Ù„ØªØ§Ù„ÙŠ</a>
          </li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}
</div>


<!-- JavaScript Ù„Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ù…Ø­Ø³Ù† -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  // ØªØ­Ø³ÙŠÙ† Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ù…Ø¹ AJAX
  document.querySelectorAll('.comment-form').forEach(form => {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const reviewId = form.getAttribute('data-review-id');
      const textarea = form.querySelector('textarea[name="text"]');
      const commentText = textarea.value.trim();
      
      if (!commentText) {
        alert('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ØªØ¹Ù„ÙŠÙ‚');
        return;
      }

      const csrftoken = form.querySelector('[name=csrfmiddlewaretoken]').value;
      const submitBtn = form.querySelector('button[type="submit"]');
      
      // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
      submitBtn.disabled = true;
      submitBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';

      try {
        const response = await fetch(form.action, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: new URLSearchParams({ text: commentText }),
        });

        if (response.ok) {
          const commentsDiv = document.querySelector(`#comments-${reviewId} .comments-list`);
          const newComment = document.createElement('div');
          newComment.classList.add('comment', 'mb-2', 'p-2', 'bg-light', 'rounded');
          newComment.innerHTML = `
            <div class="d-flex justify-content-between">
              <strong>Ø£Ù†Øª:</strong>
              <small class="text-muted">Ø§Ù„Ø¢Ù†</small>
            </div>
            <div class="comment-text">${commentText}</div>
          `;
          
          // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚Ø§Øª" Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
          const noCommentsMsg = commentsDiv.querySelector('.text-muted');
          if (noCommentsMsg && noCommentsMsg.textContent.includes('Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚Ø§Øª')) {
            noCommentsMsg.remove();
          }
          
          commentsDiv.appendChild(newComment);
          textarea.value = '';
          
          // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
          const commentsHeader = document.querySelector(`#comments-${reviewId} h6`);
          const currentCount = parseInt(commentsHeader.textContent.match(/\d+/)) || 0;
          commentsHeader.textContent = `ğŸ’¬ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª (${currentCount + 1}):`;
          
        } else {
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚.');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….');
      } finally {
        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
        submitBtn.disabled = false;
        submitBtn.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚';
      }
    });
  });

  // ØªØ­Ø³ÙŠÙ† ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù†Ø¬ÙˆÙ…
  const ratingInputs = document.querySelectorAll('.rating-input input[type="radio"]');
  const starLabels = document.querySelectorAll('.star-label');
  
  ratingInputs.forEach((input, index) => {
    input.addEventListener('change', function() {
      starLabels.forEach((label, labelIndex) => {
        if (labelIndex <= index) {
          label.style.filter = 'sepia(1) hue-rotate(45deg) saturate(2)';
        } else {
          label.style.filter = 'none';
        }
      });
    });
  });

  // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº
  document.querySelectorAll('form[action*="report-review"]').forEach(form => {
    form.addEventListener('submit', function(e) {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©ØŸ')) {
        e.preventDefault();
      }
    });
  });

  // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø³Ù„Ø³ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  const userReview = document.getElementById('your-review');
  if (userReview && window.location.hash === '#your-review') {
    userReview.scrollIntoView({ behavior: 'smooth' });
  }
});
</script>
{% endblock %}